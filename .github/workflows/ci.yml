name: CI - Pre-Release

on:
  push:
    branches: [ main, develop, 'pre-release/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  PYTHON_VERSION: '3.12'

jobs:
  # Rust Build & Test
  rust:
    name: Rust Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check Rust code
        run: |
          cd ..
          cargo check --lib
          cargo clippy --lib -- -D warnings
      
      - name: Run Rust tests
        run: |
          cd ..
          cargo test --lib --no-fail-fast
      
      - name: Build Rust library
        run: |
          cd ..
          cargo build --release --lib

  # Python Linting & Formatting
  python-lint:
    name: Python Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          pip install ruff black mypy
      
      - name: Check code formatting (Black)
        run: |
          black --check --diff ranex/ app/ examples/*.py || true
      
      - name: Lint with Ruff
        run: |
          ruff check ranex/ app/ examples/*.py || true
      
      - name: Type check with mypy
        run: |
          mypy ranex/ --ignore-missing-imports || true

  # Python Tests
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: [rust]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build ranex_core wheel
        run: |
          cd ..
          pip install maturin
          maturin build --release --out Pre-Release-v0.1/wheels
      
      - name: Install dependencies
        run: |
          pip install wheels/ranex_core-0.0.1-*.whl
          pip install pytest pytest-asyncio pytest-cov
          pip install -e .
          pip install -r app/requirements.txt || true
      
      - name: Run Python tests
        run: |
          export PYTHONPATH=$PWD:$PYTHONPATH
          pytest tests/ -v --tb=short || echo "No tests found"
      
      - name: Run example scripts (integration tests)
        run: |
          export PYTHONPATH=$PWD:$PYTHONPATH
          cd examples
          for script in *.py; do
            echo "Testing $script..."
            timeout 10 python3 "$script" > /dev/null 2>&1 && echo "✅ $script" || echo "⚠️ $script (may require server)"
          done

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build ranex_core
        run: |
          cd ..
          pip install maturin
          maturin build --release --out Pre-Release-v0.1/wheels
      
      - name: Install ranex
        run: |
          pip install wheels/ranex_core-0.0.1-*.whl
          pip install -e .
      
      - name: Run ranex scan
        run: |
          export PYTHONPATH=$PWD:$PYTHONPATH
          ranex scan || echo "Scan completed with warnings"
      
      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # Build Verification
  build-verify:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install maturin
        run: pip install maturin
      
      - name: Build wheel
        run: |
          cd ..
          maturin build --release --out Pre-Release-v0.1/wheels
      
      - name: Verify wheel exists
        run: |
          ls -lh wheels/*.whl
          test -f wheels/ranex_core-0.0.1-*.whl || exit 1
      
      - name: Install from wheel
        run: |
          pip install wheels/ranex_core-0.0.1-*.whl
          python3 -c "import ranex_core; print('✅ ranex_core imported successfully')"
      
      - name: Verify CLI works
        run: |
          pip install -e .
          ranex --help || exit 1

  # Documentation Check
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for broken links
        uses: peter-evans/link-checker@v1
        with:
          check-images: false
          base-url: 'https://github.com/your-org/ranex/tree/main/Pre-Release-v0.1'
      
      - name: Verify security docs exist
        run: |
          test -f docs/security/THREAT_MODEL.md || exit 1
          test -f docs/security/SECURITY_AUDIT.md || exit 1
          test -f docs/security/SBOM.md || exit 1
          test -f .github/SECURITY.md || exit 1
          echo "✅ All security documentation present"

  # Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [rust, python-lint, python-test, security, build-verify, docs]
    if: always()
    steps:
      - name: Check job status
        run: |
          if [ "${{ needs.rust.result }}" != "success" ] || \
             [ "${{ needs.python-test.result }}" != "success" ] || \
             [ "${{ needs.build-verify.result }}" != "success" ]; then
            echo "❌ CI failed"
            exit 1
          else
            echo "✅ CI passed"
          fi

