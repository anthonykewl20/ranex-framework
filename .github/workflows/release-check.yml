name: Release Check - Pre-Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to check (e.g., 0.0.1)'
        required: true
        type: string
  push:
    tags:
      - 'v*'

# Concurrency control: cancel outdated builds on tag pushes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-checklist:
    name: Pre-Release Checklist
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        continue-on-error: true
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        continue-on-error: true
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
        with:
          toolchain: stable
      
      - name: Cache Cargo dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ github.workspace }}/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Extract version from pyproject.toml
        id: get_version_release
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep -E '^version = ' pyproject.toml | sed -E 's/version = "(.+)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version from pyproject.toml: $VERSION"
      
      - name: Check version consistency
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          EXPECTED_VERSION="${{ github.event.inputs.version || github.ref_name }}"
          # Strip 'v' prefix if present
          EXPECTED_VERSION="${EXPECTED_VERSION#v}"
          ACTUAL_VERSION="${{ steps.get_version_release.outputs.version }}"
          echo "Expected version: $EXPECTED_VERSION"
          echo "Actual version in pyproject.toml: $ACTUAL_VERSION"
          
          # Check pyproject.toml version matches expected
          if [ "$ACTUAL_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "❌ Version mismatch: expected $EXPECTED_VERSION, found $ACTUAL_VERSION"
            exit 1
          fi
          
          # Check Cargo.toml if it exists
          if [ -f "Cargo.toml" ]; then
            CARGO_VERSION=$(grep -E '^version = ' Cargo.toml | sed -E 's/version = "(.+)"/\1/')
            if [ "$CARGO_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "❌ Cargo.toml version mismatch: expected $EXPECTED_VERSION, found $CARGO_VERSION"
              exit 1
            fi
            echo "✅ Cargo.toml version matches"
          fi
          
          echo "✅ Version consistent"
      
      - name: Verify all required files exist
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "CHANGELOG.md"
            "pyproject.toml"
            "docs/security/THREAT_MODEL.md"
            "docs/security/SECURITY_AUDIT.md"
            "docs/security/SBOM.md"
            ".github/SECURITY.md"
            ".github/dependabot.yml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file"
            else
              echo "❌ Missing: $file"
              exit 1
            fi
          done
          
          # Check wheel exists (may be wildcard)
          if ls wheels/ranex_core-*.whl 1> /dev/null 2>&1; then
            echo "✅ Wheel file exists"
          else
            echo "⚠️ Wheel file not found (will be built)"
          fi
      
      - name: Build wheel
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir maturin
            maturin build --release --out wheels
          else
            echo "⚠️ No Cargo.toml found - skipping wheel build (using pre-built wheel if available)"
          fi
      
      - name: Verify wheel installation
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.get_version_release.outputs.version }}"
          pip install --no-cache-dir wheels/ranex_core-${VERSION}-*.whl
          python3 -c "import ranex_core; print('✅ ranex_core imports')"
          python3 -c "from ranex_core import SchemaValidator; print('✅ SchemaValidator available')" || echo "⚠️ SchemaValidator import check skipped"
      
      - name: Run basic smoke tests
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir -e .
          else
            echo "⚠️ No Cargo.toml - installing CLI dependencies"
            pip install --no-cache-dir typer rich PyYAML
            export PYTHONPATH="${PYTHONPATH:-}:$PWD"
            echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          fi
          export PYTHONPATH="${PYTHONPATH:-}:$PWD"
          
          # Test CLI
          ranex --help || exit 1
          
          # Test imports
          python3 -c "from ranex import Contract; print('✅ Contract available')" || echo "⚠️ Contract import check skipped"
          python3 -c "from ranex_core import StateMachine; print('✅ StateMachine available')" || echo "⚠️ StateMachine import check skipped"
          
          echo "✅ Smoke tests passed"
      
      - name: Check documentation links
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          # Basic check - verify docs reference each other correctly
          grep -q "THREAT_MODEL.md" README.md || echo "⚠️ README doesn't reference threat model"
          grep -q "SECURITY_AUDIT.md" README.md || echo "⚠️ README doesn't reference audit"
          grep -q "SBOM.md" README.md || echo "⚠️ README doesn't reference SBOM"
      
      - name: Release checklist summary
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          echo "## Pre-Release Checklist ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Version consistency checked" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Required files present" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Wheel builds successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Wheel installs and imports" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Smoke tests pass" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Security documentation present" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Ready for Pre-Release" >> $GITHUB_STEP_SUMMARY
      
      - name: Release checklist failure summary
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          echo "## Pre-Release Checklist ❌" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Pre-Release checks failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed steps above and fix the issues before releasing." >> $GITHUB_STEP_SUMMARY
