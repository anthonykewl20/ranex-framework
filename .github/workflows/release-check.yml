name: Release Check - Pre-Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to check (e.g., 0.0.1)'
        required: true
        type: string
  push:
    tags:
      - 'v*'

jobs:
  release-checklist:
    name: Pre-Release Checklist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check version consistency
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          echo "Checking version: $VERSION"
          
          # Check pyproject.toml
          grep -q "version = \"$VERSION\"" pyproject.toml || exit 1
          
          # Check Cargo.toml (in parent)
          cd ..
          grep -q "version = \"$VERSION\"" Cargo.toml || exit 1
          
          echo "✅ Version consistent"
      
      - name: Verify all required files exist
        run: |
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "CHANGELOG.md"
            "pyproject.toml"
            "wheels/ranex_core-0.0.1-*.whl"
            "docs/security/THREAT_MODEL.md"
            "docs/security/SECURITY_AUDIT.md"
            "docs/security/SBOM.md"
            ".github/SECURITY.md"
            ".github/dependabot.yml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if ls $file 1> /dev/null 2>&1; then
              echo "✅ $file"
            else
              echo "❌ Missing: $file"
              exit 1
            fi
          done
      
      - name: Build wheel
        run: |
          cd ..
          pip install maturin
          maturin build --release --out Pre-Release-v0.1/wheels
      
      - name: Verify wheel installation
        run: |
          pip install wheels/ranex_core-0.0.1-*.whl
          python3 -c "import ranex_core; print('✅ ranex_core imports')"
          python3 -c "from ranex_core import SchemaValidator; print('✅ SchemaValidator available')"
      
      - name: Run basic smoke tests
        run: |
          pip install -e .
          export PYTHONPATH=$PWD:$PYTHONPATH
          
          # Test CLI
          ranex --help || exit 1
          
          # Test imports
          python3 -c "from ranex import Contract; print('✅ Contract available')"
          python3 -c "from ranex_core import StateMachine; print('✅ StateMachine available')"
          
          echo "✅ Smoke tests passed"
      
      - name: Check documentation links
        run: |
          # Basic check - verify docs reference each other correctly
          grep -q "THREAT_MODEL.md" README.md || echo "⚠️ README doesn't reference threat model"
          grep -q "SECURITY_AUDIT.md" README.md || echo "⚠️ README doesn't reference audit"
          grep -q "SBOM.md" README.md || echo "⚠️ README doesn't reference SBOM"
      
      - name: Release checklist summary
        run: |
          echo "## Pre-Release Checklist ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Version consistency checked" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Required files present" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Wheel builds successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Wheel installs and imports" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Smoke tests pass" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Security documentation present" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Ready for Pre-Release" >> $GITHUB_STEP_SUMMARY

