name: Security - Pre-Release

on:
  push:
    branches: [ main, develop, 'pre-release/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

# Concurrency control: cancel outdated builds on PRs to save costs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Dependency Vulnerability Scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: '3.12'
          # Note: cache disabled to avoid warnings - using explicit actions/cache instead
      
      - name: Cache pip dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        continue-on-error: true
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
        with:
          toolchain: stable
      
      - name: Cache Cargo dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ github.workspace }}/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Extract version from pyproject.toml
        id: get_version_depscan
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep -E '^version = ' pyproject.toml | sed -E 's/version = "(.+)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Build ranex_core
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir maturin
            maturin build --release --out wheels
          else
            echo "⚠️ No Cargo.toml found - skipping wheel build"
          fi
      
      - name: Install dependencies
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.get_version_depscan.outputs.version }}"
          pip install --no-cache-dir wheels/ranex_core-${VERSION}-*.whl || echo "⚠️ Wheel not found"
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir -e .
          else
            echo "⚠️ No Cargo.toml - installing CLI dependencies"
            pip install --no-cache-dir typer rich PyYAML
            export PYTHONPATH="${PYTHONPATH:-}:$PWD"
            echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          fi
      
      - name: Run dependency scan
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="${PYTHONPATH:-}:$PWD"
          ranex scan
      
      - name: Check for known vulnerabilities (Python)
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          pip install --no-cache-dir safety
          safety check --file pyproject.toml
      
      - name: Check for known vulnerabilities (Rust)
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-audit
          cargo audit

  # Code Security Scanning
  code-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        continue-on-error: true
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
        with:
          toolchain: stable
      
      - name: Cache Cargo dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ github.workspace }}/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Extract version from pyproject.toml
        id: get_version_codescan
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep -E '^version = ' pyproject.toml | sed -E 's/version = "(.+)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Build ranex_core
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir maturin
            maturin build --release --out wheels
          else
            echo "⚠️ No Cargo.toml found - skipping wheel build"
          fi
      
      - name: Install ranex
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.get_version_codescan.outputs.version }}"
          pip install --no-cache-dir wheels/ranex_core-${VERSION}-*.whl || echo "⚠️ Wheel not found"
          if [ -f "Cargo.toml" ]; then
            pip install --no-cache-dir -e .
          else
            echo "⚠️ No Cargo.toml - installing CLI dependencies"
            pip install --no-cache-dir typer rich PyYAML
            export PYTHONPATH="${PYTHONPATH:-}:$PWD"
            echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          fi
      
      - name: Run security scan on codebase
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="${PYTHONPATH:-}:$PWD"
          # Scan Python files
          find ranex/ app/ examples/ -name "*.py" -exec python3 -c "
          from ranex_core import UnifiedSecurityScanner
          import sys
          scanner = UnifiedSecurityScanner.new()
          with open(sys.argv[1]) as f:
              content = f.read()
          result = scanner.scan_content(content)
          if not result.secure:
              print(f'⚠️ Security issues in {sys.argv[1]}')
              for v in result.violations:
                  print(f'  - {v.severity}: {v.message}')
              sys.exit(1)
          " {} \;

  # SBOM Generation
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        continue-on-error: true
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Generate Python SBOM
        id: python_sbom
        shell: bash
        run: |
          set -euo pipefail
          pip install --no-cache-dir cyclonedx-bom || pip install --no-cache-dir cyclonedx-py || echo "⚠️ cyclonedx-bom not available"
          if command -v cyclonedx-py &> /dev/null; then
            cyclonedx-py -o sbom-python.json -pb && echo "python_sbom=true" >> $GITHUB_OUTPUT || echo "python_sbom=false" >> $GITHUB_OUTPUT
          elif command -v cyclonedx &> /dev/null; then
            cyclonedx py -o sbom-python.json && echo "python_sbom=true" >> $GITHUB_OUTPUT || echo "python_sbom=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ No cyclonedx tool available - skipping Python SBOM"
            echo "python_sbom=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for Cargo.toml (Rust SBOM)
        id: check_cargo_sbom
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Cargo.toml" ]; then
            echo "cargo_exists=true" >> $GITHUB_OUTPUT
          else
            echo "cargo_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Rust SBOM
        if: steps.check_cargo_sbom.outputs.cargo_exists == 'true'
        id: rust_sbom
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-cyclonedx --quiet || echo "⚠️ cargo-cyclonedx installation failed"
          if command -v cargo-cyclonedx &> /dev/null || cargo cyclonedx --help &> /dev/null; then
            cargo cyclonedx -o sbom-rust.json && echo "rust_sbom=true" >> $GITHUB_OUTPUT || echo "rust_sbom=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ cargo-cyclonedx not available - skipping Rust SBOM"
            echo "rust_sbom=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload SBOM artifacts
        if: steps.python_sbom.outputs.python_sbom == 'true' || steps.rust_sbom.outputs.rust_sbom == 'true'
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4.0.0
        continue-on-error: true
        with:
          name: sbom
          path: |
            sbom-*.json
          retention-days: 90
      
      - name: Skip SBOM upload (no files generated)
        if: steps.python_sbom.outputs.python_sbom != 'true' && (steps.check_cargo_sbom.outputs.cargo_exists != 'true' || steps.rust_sbom.outputs.rust_sbom != 'true')
        shell: bash
        run: |
          set -euo pipefail
          echo "⚠️ No SBOM files generated - skipping upload"
          echo "This is expected if cyclonedx tools are not available or no Rust code exists"

  # Security Policy Check
  security-policy:
    name: Security Policy Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Verify security documentation
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/SECURITY.md || exit 1
          test -f docs/security/THREAT_MODEL.md || exit 1
          test -f docs/security/SECURITY_AUDIT.md || exit 1
          test -f docs/security/SBOM.md || exit 1
          echo "✅ All security documentation present"
      
      - name: Verify Dependabot config
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/dependabot.yml || exit 1
          echo "✅ Dependabot configured"
